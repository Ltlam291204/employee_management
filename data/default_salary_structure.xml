<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <!-- Sequence cho Payslip -->
        <record id="seq_payroll_payslip" model="ir.sequence">
            <field name="name">Payroll Payslip Sequence</field>
            <field name="code">payroll.payslip</field>
            <field name="prefix">PAY/</field>
            <field name="padding">5</field>
            <field name="number_next">1</field>
            <field name="number_increment">1</field>
        </record>

        <!-- Cấu trúc lương Việt Nam -->
        <record id="salary_structure_vn" model="payroll.structure">
            <field name="name">Cấu trúc lương Việt Nam</field>
            <field name="code">VN_SALARY</field>
            <field name="sequence">10</field>
            <field name="note">Cấu trúc lương theo quy định tại Việt Nam với BHXH, BHYT, BHTN và Thuế TNCN</field>
        </record>

        <!-- 1. Lương cơ bản (chỉ base_wage) -->
        <record id="rule_basic_salary" model="payroll.salary.rule">
            <field name="name">Lương cơ bản</field>
            <field name="code">BASIC</field>
            <field name="sequence">10</field>
            <field name="category">basic</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if payslip and payslip.contract_id:
    base_wage = payslip.contract_id.base_wage
    if base_wage:
        result = float(base_wage)</field>
        </record>

        <!-- 2. Tổng phúc lợi -->
        <record id="rule_total_benefits" model="payroll.salary.rule">
            <field name="name">Tổng phúc lợi</field>
            <field name="code">BENEFITS</field>
            <field name="sequence">20</field>
            <field name="category">allowance</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if payslip and payslip.contract_id:
    for benefit in payslip.contract_id.benefit_ids:
        if benefit.amount:
            result += float(benefit.amount)</field>
        </record>

        <!-- 3. Tổng thu nhập (Gross) -->
        <record id="rule_gross_salary" model="payroll.salary.rule">
            <field name="name">Tổng thu nhập</field>
            <field name="code">GROSS</field>
            <field name="sequence">50</field>
            <field name="category">gross</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if rules:
    basic = rules.get('BASIC', 0.0) or 0.0
    benefits = rules.get('BENEFITS', 0.0) or 0.0
    result = float(basic) + float(benefits)</field>
        </record>

        <!-- 4. BHXH - 8% (tính trên GROSS) -->
        <record id="rule_bhxh" model="payroll.salary.rule">
            <field name="name">Bảo hiểm xã hội (8%)</field>
            <field name="code">BHXH</field>
            <field name="sequence">60</field>
            <field name="category">deduction</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if payslip and payslip.contract_id:
    has_bhxh = False
    for c in payslip.contract_id.contribution_ids:
        if c.contribution_type_id and c.contribution_type_id.code == 'BHXH':
            has_bhxh = True
            break
    if has_bhxh and rules:
        gross = rules.get('GROSS', 0.0) or 0.0
        if gross > 0:
            result = -float(gross) * 0.08</field>
        </record>

        <!-- 5. BHYT - 1.5% (tính trên GROSS) -->
        <record id="rule_bhyt" model="payroll.salary.rule">
            <field name="name">Bảo hiểm y tế (1.5%)</field>
            <field name="code">BHYT</field>
            <field name="sequence">70</field>
            <field name="category">deduction</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if payslip and payslip.contract_id:
    has_bhyt = False
    for c in payslip.contract_id.contribution_ids:
        if c.contribution_type_id and c.contribution_type_id.code == 'BHYT':
            has_bhyt = True
            break
    if has_bhyt and rules:
        gross = rules.get('GROSS', 0.0) or 0.0
        if gross > 0:
            result = -float(gross) * 0.015</field>
        </record>

        <!-- 6. BHTN - 1% (tính trên GROSS, có giới hạn) -->
        <record id="rule_bhtn" model="payroll.salary.rule">
            <field name="name">Bảo hiểm thất nghiệp (1%)</field>
            <field name="code">BHTN</field>
            <field name="sequence">80</field>
            <field name="category">deduction</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if payslip and payslip.contract_id:
    has_bhtn = False
    for c in payslip.contract_id.contribution_ids:
        if c.contribution_type_id and c.contribution_type_id.code == 'BHTN':
            has_bhtn = True
            break
    if has_bhtn and rules:
        gross = rules.get('GROSS', 0.0) or 0.0
        if gross > 0:
            max_bhtn = 4960000 * 20
            bhtn_base = min(float(gross), max_bhtn)
            result = -bhtn_base * 0.01</field>
        </record>

        <!-- 7. Thu nhập trước thuế -->
        <record id="rule_taxable_income" model="payroll.salary.rule">
            <field name="name">Thu nhập trước thuế</field>
            <field name="code">TAXABLE</field>
            <field name="sequence">90</field>
            <field name="category">other</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="False"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if rules:
    gross = rules.get('GROSS', 0.0) or 0.0
    bhxh = abs(rules.get('BHXH', 0.0) or 0.0)
    bhyt = abs(rules.get('BHYT', 0.0) or 0.0)
    bhtn = abs(rules.get('BHTN', 0.0) or 0.0)
    result = float(gross) - float(bhxh) - float(bhyt) - float(bhtn)</field>
        </record>

        <!-- 8. Thuế TNCN -->
        <record id="rule_personal_income_tax" model="payroll.salary.rule">
            <field name="name">Thuế thu nhập cá nhân</field>
            <field name="code">PIT</field>
            <field name="sequence">100</field>
            <field name="category">deduction</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if rules:
    taxable = rules.get('TAXABLE', 0.0) or 0.0
    taxable = float(taxable)
    deduction = 11000000
    taxable_after_deduction = max(0, taxable - deduction)
    tax = 0.0
    if taxable_after_deduction &lt;= 5000000:
        tax = taxable_after_deduction * 0.05
    elif taxable_after_deduction &lt;= 10000000:
        tax = 5000000 * 0.05 + (taxable_after_deduction - 5000000) * 0.10
    elif taxable_after_deduction &lt;= 18000000:
        tax = 5000000 * 0.05 + 5000000 * 0.10 + (taxable_after_deduction - 10000000) * 0.15
    elif taxable_after_deduction &lt;= 32000000:
        tax = 5000000 * 0.05 + 5000000 * 0.10 + 8000000 * 0.15 + (taxable_after_deduction - 18000000) * 0.20
    elif taxable_after_deduction &lt;= 52000000:
        tax = 5000000 * 0.05 + 5000000 * 0.10 + 8000000 * 0.15 + 14000000 * 0.20 + (taxable_after_deduction - 32000000) * 0.25
    elif taxable_after_deduction &lt;= 80000000:
        tax = 5000000 * 0.05 + 5000000 * 0.10 + 8000000 * 0.15 + 14000000 * 0.20 + 20000000 * 0.25 + (taxable_after_deduction - 52000000) * 0.30
    else:
        tax = 5000000 * 0.05 + 5000000 * 0.10 + 8000000 * 0.15 + 14000000 * 0.20 + 20000000 * 0.25 + 28000000 * 0.30 + (taxable_after_deduction - 80000000) * 0.35
    result = -tax</field>
        </record>

        <!-- 9. Lương thực nhận (Net) -->
        <record id="rule_net_salary" model="payroll.salary.rule">
            <field name="name">Lương thực nhận</field>
            <field name="code">NET</field>
            <field name="sequence">110</field>
            <field name="category">net</field>
            <field name="structure_id" ref="salary_structure_vn"/>
            <field name="amount_type">code</field>
            <field name="appears_on_payslip" eval="True"/>
            <field name="is_active" eval="True"/>
            <field name="amount_python_compute">result = 0.0
if rules:
    gross = rules.get('GROSS', 0.0) or 0.0
    bhxh = abs(rules.get('BHXH', 0.0) or 0.0)
    bhyt = abs(rules.get('BHYT', 0.0) or 0.0)
    bhtn = abs(rules.get('BHTN', 0.0) or 0.0)
    pit = abs(rules.get('PIT', 0.0) or 0.0)
    result = float(gross) - float(bhxh) - float(bhyt) - float(bhtn) - float(pit)</field>
        </record>

    </data>
</odoo>